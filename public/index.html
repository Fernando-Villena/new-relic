<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Obserbavilidad</title>
  <link rel="icon" type="image/png" href="assets/logo-title.png">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="assets/css/overlay.css">
  <link rel="stylesheet" href="assets/css/spinner.css">
  <link rel="stylesheet" href="assets/css/tabs.css">
  <link rel="stylesheet" href="assets/css/status.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <style>
    /* Agrandar el contenedor principal notablemente */
    .container {
      max-width: 1100px !important;
    }

    .entity-config-container {
      display: grid;
      grid-template-columns: 1.2fr 320px;
      /* Distribuci√≥n m√°s equitativa */
      gap: 50px;
      /* Mucho m√°s aire entre columnas */
      margin: 20px 0;
      background: rgba(13, 17, 23, 0.7);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 35px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.4);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      height: 32px;
      /* Altura fija para alineaci√≥n perfecta */
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding-bottom: 10px;
      white-space: nowrap;
      /* Evita que el t√≠tulo se rompa en varias l√≠neas */
      gap: 20px;
      /* Asegura espacio entre el texto y los botones */
    }

    .config-section h3 {
      font-family: 'Inter', sans-serif;
      font-size: 1.02em;
      letter-spacing: 0.5px;
      color: #f0f6fc !important;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
    }

    .config-section h3::before {
      content: '';
      width: 4px;
      height: 16px;
      background: #3fb950;
      border-radius: 2px;
    }

    /* Grid de columnas para selectores */
    #entityTypeSelectors {
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    #policyFieldSelectors,
    #alertFieldSelectors {
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .checkbox-group {
      display: grid;
      gap: 8px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.88em;
      color: #adbac7;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .checkbox-group label:hover {
      background: rgba(63, 185, 80, 0.1);
      border-color: rgba(63, 185, 80, 0.2);
      color: #f0f6fc;
      transform: translateX(3px);
    }

    .checkbox-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #3fb950;
      filter: drop-shadow(0 0 5px rgba(63, 185, 80, 0.3));
      margin: 0;
      flex-shrink: 0;
    }

    .control-pill {
      background: rgba(88, 166, 255, 0.08);
      color: #58a6ff;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7em;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s;
      border: 1px solid rgba(88, 166, 255, 0.2);
    }

    .control-pill:hover {
      background: #58a6ff;
      color: #0d1117;
    }

    .btn-primary {
      background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(46, 160, 67, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      width: fit-content;
      margin-top: 5px;
      flex-shrink: 0;
      /* Evita que el bot√≥n se achique cuando hay texto largo */
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 160, 67, 0.4);
      filter: brightness(1.1);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .status-container {
      margin-top: 15px;
      min-height: 48px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      /* Permite que el mensaje baje si no hay espacio */
      gap: 15px;
    }

    .status-container pre {
      margin: 0;
      background: transparent !important;
      padding: 0 !important;
      white-space: pre-wrap;
      /* Permite que el texto largo salte de l√≠nea */
      word-break: break-word;
    }

    .info-banner {
      background: rgba(56, 139, 253, 0.08);
      border-left: 3px solid #388bfd;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      color: #adbac7;
      font-size: 0.85em;
      line-height: 1.4;
    }

    /* Reducir margen de inputs para que no se vea comprimido */
    /* Quitar flechas por defecto de los inputs number */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>
  <div class="container">


    <div class="card">

      <div class="tab-menu">
        <span class="tab active" onclick="showTab('tab-use')">Policy</span>
        <span class="tab" onclick="showTab('tab-example')">Alertas Configuradas</span>
        <span class="tab" onclick="showTab('tab-entities')">Entidades</span>
      </div>

      <div id="tab-use" class="tab-content active">
        <div class="info-banner">
          <strong>B√∫squeda por Pol√≠tica:</strong> Selecciona los campos que deseas incluir en el reporte. La app
          filtrar√° las condiciones asociadas al ID ingresado abajo.
        </div>

        <div style="margin: 20px 0; display: flex; flex-direction: column; gap: 8px;">
          <div style="display: flex; align-items: center; gap: 10px; position: relative; max-width: 300px;">
            <div
              style="position: absolute; left: 12px; color: #3fb950; font-weight: 800; font-size: 0.7em; letter-spacing: 1px; pointer-events: none; text-transform: uppercase;">
              ID
            </div>
            <input type="number" id="policyId" placeholder="Ingrese ID..."
              style="padding: 10px 15px 10px 40px; width: 100%; margin-bottom: 0 !important; font-weight: 600; font-size: 0.95em; letter-spacing: 1px; color: #fff; background: rgba(0,0,0,0.4); border: 1.5px solid rgba(63, 185, 80, 0.2); border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
          </div>
          <span style="font-size: 0.72em; color: #8b949e; margin-left: 5px; font-style: italic;">Ejemplo: 1234567</span>
        </div>

        <div class="entity-config-container" style="grid-template-columns: 1fr; margin-top: 20px;">
          <div class="config-section">
            <div class="section-header">
              <h3>Campos a Exportar</h3>
              <div style="display: flex; gap: 8px;">
                <a href="#" class="control-pill"
                  onclick="toggleChecks('policyFieldSelectors', true); return false;">Todos</a>
                <a href="#" class="control-pill"
                  onclick="toggleChecks('policyFieldSelectors', false); return false;">Ninguno</a>
              </div>
            </div>

            <div class="checkbox-group" id="policyFieldSelectors">
              <label><input type="checkbox" value="PolicyID" checked> <span>Policy ID</span></label>
              <label><input type="checkbox" value="Policy" checked> <span>Nombre Pol√≠tica</span></label>
              <label><input type="checkbox" value="ID" checked> <span>ID Alerta</span></label>
              <label><input type="checkbox" value="NombreAlerta" checked> <span>Nombre Alerta</span></label>
              <label><input type="checkbox" value="Descripci√≥n" checked> <span>Descripci√≥n</span></label>
              <label><input type="checkbox" value="Habilitada" checked> <span>Habilitada</span></label>
              <label><input type="checkbox" value="Tipo" checked> <span>Tipo</span></label>
              <label><input type="checkbox" value="Runbook" checked> <span>Runbook</span></label>
              <label><input type="checkbox" value="NRQL" checked> <span>NRQL</span></label>
              <label><input type="checkbox" value="Condici√≥n" checked> <span>Condici√≥n</span></label>
              <label><input type="checkbox" value="GuidEntidad" checked> <span>GUID Entidad</span></label>
              <label><input type="checkbox" value="NombreEntidad" checked> <span>Nombre Entidad</span></label>
              <label><input type="checkbox" value="TipoEntidad" checked> <span>Tipo Entidad</span></label>
            </div>
          </div>
        </div>

        <div class="status-container">
          <button id="exportBtn" class="btn-primary" style="margin-top: 0;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Exportar alertas
          </button>
          <div id="status"></div>
        </div>
      </div>


      <div id="tab-example" class="tab-content">
        <div class="info-banner">
          <strong>Configuraci√≥n de Alertas:</strong> Selecciona los campos que deseas incluir en el reporte global de
          alertas. Se extraer√°n todas las condiciones NRQL configuradas en la cuenta.
        </div>

        <div class="entity-config-container" style="grid-template-columns: 1fr;">
          <div class="config-section">
            <div class="section-header">
              <h3>Campos a Exportar</h3>
              <div style="display: flex; gap: 8px;">
                <a href="#" class="control-pill"
                  onclick="toggleChecks('alertFieldSelectors', true); return false;">Todos</a>
                <a href="#" class="control-pill"
                  onclick="toggleChecks('alertFieldSelectors', false); return false;">Ninguno</a>
              </div>
            </div>

            <div class="checkbox-group" id="alertFieldSelectors">
              <label><input type="checkbox" value="PolicyID" checked> <span>Policy ID</span></label>
              <label><input type="checkbox" value="Policy" checked> <span>Nombre Pol√≠tica</span></label>
              <label><input type="checkbox" value="ID" checked> <span>ID Alerta</span></label>
              <label><input type="checkbox" value="NombreAlerta" checked> <span>Nombre Alerta</span></label>
              <label><input type="checkbox" value="Descripci√≥n" checked> <span>Descripci√≥n</span></label>
              <label><input type="checkbox" value="Habilitada" checked> <span>Habilitada</span></label>
              <label><input type="checkbox" value="Tipo" checked> <span>Tipo</span></label>
              <label><input type="checkbox" value="Runbook" checked> <span>Runbook</span></label>
              <label><input type="checkbox" value="NRQL" checked> <span>NRQL</span></label>
              <label><input type="checkbox" value="Condici√≥n" checked> <span>Condici√≥n</span></label>
              <label><input type="checkbox" value="GuidEntidad" checked> <span>GUID Entidad</span></label>
              <label><input type="checkbox" value="NombreEntidad" checked> <span>Nombre Entidad</span></label>
              <label><input type="checkbox" value="TipoEntidad" checked> <span>Tipo Entidad</span></label>
            </div>
          </div>
        </div>

        <div class="status-container" style="margin-top: 10px;">
          <button id="exportAllBtn" class="btn-primary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Exportar Todas las Alertas
          </button>
          <div id="statusAll"></div>
        </div>
      </div>


      <div id="tab-entities" class="tab-content">
        <div class="info-banner">
          <strong>Configuraci√≥n del Reporte:</strong> Selecciona los tipos de entidades que deseas incluir y los campos
          que se mostrar√°n en las columnas del archivo Excel. El reporte se generar√° en tiempo real cruzando los datos
          con las alertas configuradas.
        </div>

        <div class="entity-config-container">
          <!-- Columna 1: Tipos de Entidad -->
          <div class="config-section">
            <div class="section-header" style="padding-right: 15px;">
              <h3>Entidades a Incluir</h3>
              <div style="display: flex; gap: 8px;">
                <a href="#" class="control-pill"
                  onclick="toggleChecks('entityTypeSelectors', true); return false;">Todos</a>
                <a href="#" class="control-pill"
                  onclick="toggleChecks('entityTypeSelectors', false); return false;">Ninguno</a>
              </div>
            </div>

            <div class="checkbox-group" id="entityTypeSelectors">
              <label><input type="checkbox" value="APM Service" checked> <span>APM Services</span></label>
              <label><input type="checkbox" value="Browser Application" checked> <span>Browser Apps</span></label>
              <label><input type="checkbox" value="Mobile Application" checked> <span>Mobile Apps</span></label>
              <label><input type="checkbox" value="HOST" checked> <span>Servers (Hosts)</span></label>
              <label><input type="checkbox" value="Synthetic Monitor" checked> <span>Synthetics</span></label>
              <label><input type="checkbox" value="WORKLOAD" checked> <span>Workloads</span></label>
              <label><input type="checkbox" value="DASHBOARD" checked> <span>Dashboards</span></label>
              <label><input type="checkbox" value="KEY_TRANSACTION" checked> <span>Key Transactions</span></label>
              <label><input type="checkbox" value="VSPHERE_VM" checked> <span>vSphere VMs</span></label>
              <label><input type="checkbox" value="FIREWALL" checked> <span>Firewalls</span></label>
              <label><input type="checkbox" value="SWITCH" checked> <span>Switches</span></label>
              <label><input type="checkbox" value="TRAP_DEVICE" checked> <span>SNMP Devices</span></label>
            </div>
          </div>

          <!-- Columna 2: Campos del Excel -->
          <div class="config-section" style="border-left: 1px solid rgba(255,255,255,0.05); padding-left: 30px;">
            <div class="section-header">
              <h3>Campos del Excel</h3>
              <div style="display: flex; gap: 8px;">
                <a href="#" class="control-pill" onclick="toggleChecks('fieldSelectors', true); return false;">Todos</a>
                <a href="#" class="control-pill"
                  onclick="toggleChecks('fieldSelectors', false); return false;">Ninguno</a>
              </div>
            </div>
            <div class="checkbox-group" id="fieldSelectors" style="grid-template-columns: 1fr;">
              <label><input type="checkbox" value="Nombre" checked> <span>Nombre</span></label>
              <label><input type="checkbox" value="Tipo" checked> <span>Tipo</span></label>
              <label><input type="checkbox" value="TieneAlertas" checked> <span>Tiene Alertas</span></label>
              <label><input type="checkbox" value="AlertasVinculadas" checked> <span>Alertas Vinculadas</span></label>
              <label><input type="checkbox" value="GUID" checked> <span>GUID</span></label>
            </div>
          </div>
        </div>

        <div class="status-container" style="margin-top: 10px;">
          <button id="exportEntitiesBtn" class="btn-primary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Generar Reporte Excel
          </button>
          <div id="statusEntities"></div>
        </div>
      </div>




    </div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">Extrayendo alertas<span class="dot">.</span><span class="dot">.</span><span
        class="dot">.</span></div>
  </div>


  <script>

    const BASE_URL = window.location.hostname.includes("localhost") ?
      "http://localhost:3000" :
      "https://new-relic.onrender.com";

    // const BASE_URL = "http://localhost:3000";

    // üîπ Funci√≥n gen√©rica para obtener alertas
    async function fetchAlerts(endpoint, body = null) {
      const options = {
        method: body ? "POST" : "GET",
        headers: { "Content-Type": "application/json" },
        body: body ? JSON.stringify(body) : null,
      };

      const response = await fetch(`${BASE_URL}/${endpoint}`, options);
      if (!response.ok) throw new Error("Error al obtener alertas del servidor");
      return await response.json();
    }

    // üîπ Transformar condiciones en filas de Excel
    function mapAlertsToRows(conditions) {
      return conditions.map(c => ({
        PolicyID: c.policyId || "",
        Policy: c.policyName || "",
        ID: c.id,
        NombreAlerta: c.name,
        Descripci√≥n: c.description || "",
        Habilitada: c.enabled ? "S√≠" : "No",
        Tipo: c.type,
        Runbook: c.runbookUrl || "No",
        NRQL: c.nrql?.query || "",
        Condici√≥n: c.termsText || "",
        GuidEntidad: c.realEntity?.guid || "",
        NombreEntidad: c.realEntity?.name || "",
        TipoEntidad: c.realEntity?.type || ""
      }));
    }


    // üîπ Funci√≥n gen√©rica para exportar a Excel
    function exportToExcel(conditions, filename) {
      const rows = mapAlertsToRows(conditions);
      const workbook = XLSX.utils.book_new();
      const worksheet = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(workbook, worksheet, "Alertas");
      XLSX.writeFile(workbook, filename);
      return rows.length;
    }

    // Auxiliar para seleccionar/deseleccionar todo
    window.toggleChecks = (containerId, checked) => {
      document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(i => i.checked = checked);
    };

    // üîπ Mostrar mensaje con estilo consola
    function setStatus(el, msg, type = "info") {
      const colors = {
        success: "#4caf50",   // verde
        error: "#ff4d4f",     // rojo
        warning: "#ffdd57",   // amarillo
        info: "#00c0ff"       // celeste
      };

      el.innerHTML = `<pre><code>// <span style="color:${colors[type]}; font-weight:bold;">${msg}</span></code></pre>`;
    }

    // Helper para mapear alertas a filas seg√∫n selecci√≥n
    function mapAlertsToSelectedFields(alerts, selectedFields) {
      return alerts.map(c => {
        const row = {};
        if (selectedFields.includes("PolicyID")) row["Policy ID"] = c.policyId || "";
        if (selectedFields.includes("Policy")) row["Nombre Pol√≠tica"] = c.policyName || "";
        if (selectedFields.includes("ID")) row["ID Alerta"] = c.id;
        if (selectedFields.includes("NombreAlerta")) row["Nombre Alerta"] = c.name;
        if (selectedFields.includes("Descripci√≥n")) row["Descripci√≥n"] = c.description || "";
        if (selectedFields.includes("Habilitada")) row["Habilitada"] = c.enabled ? "S√≠" : "No";
        if (selectedFields.includes("Tipo")) row["Tipo"] = c.type;
        if (selectedFields.includes("Runbook")) row["Runbook"] = c.runbookUrl || "No";
        if (selectedFields.includes("NRQL")) row["NRQL"] = c.nrql?.query || "";
        if (selectedFields.includes("Condici√≥n")) row["Condici√≥n"] = c.termsText || "";
        if (selectedFields.includes("GuidEntidad")) row["GUID Entidad"] = c.realEntity?.guid || "";
        if (selectedFields.includes("NombreEntidad")) row["Nombre Entidad"] = c.realEntity?.name || "";
        if (selectedFields.includes("TipoEntidad")) row["Tipo Entidad"] = c.realEntity?.type || "";
        return row;
      });
    }

    // üîπ Exportar por Policy ID
    document.getElementById("exportBtn").addEventListener("click", async () => {
      const status = document.getElementById("status");
      const policyId = document.getElementById("policyId").value.trim();
      const selectedFields = Array.from(document.querySelectorAll("#policyFieldSelectors input:checked")).map(i => i.value);

      if (!policyId) {
        setStatus(status, "‚ùå Debes ingresar una Policy ID", "error");
        return;
      }
      if (selectedFields.length === 0) {
        setStatus(status, "‚ö†Ô∏è Selecciona al menos un campo", "warning");
        return;
      }

      showLoading();
      try {
        const alerts = await fetchAlerts("alerts", { policyId });

        if (alerts.length === 0) {
          setStatus(status, "‚ö†Ô∏è No existen alertas asociadas a esta Policy ID", "warning");
          return;
        }

        const rows = mapAlertsToSelectedFields(alerts, selectedFields);
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(workbook, worksheet, "Alertas Policy");
        XLSX.writeFile(workbook, `alerts_policy_${policyId}.xlsx`);

        setStatus(status, `‚úÖ Exportadas ${alerts.length} alertas a alerts_policy_${policyId}.xlsx`, "success");
      } catch (err) {
        console.error(err);
        setStatus(status, "‚ùå Error al exportar alertas", "error");
      } finally {
        hideLoading();
      }
    });

    // üîπ Exportar todas las alertas con CONFIGURACI√ìN
    document.getElementById("exportAllBtn").addEventListener("click", async () => {
      const statusAll = document.getElementById("statusAll");

      // Obtener campos seleccionados
      const selectedFields = Array.from(document.querySelectorAll("#alertFieldSelectors input:checked")).map(i => i.value);

      if (selectedFields.length === 0) {
        setStatus(statusAll, "‚ö†Ô∏è Debes seleccionar al menos un campo para el Excel", "warning");
        return;
      }

      showLoading();
      try {
        const allAlerts = await fetchAlerts("alerts-all");

        if (allAlerts.length === 0) {
          setStatus(statusAll, "‚ö†Ô∏è No hay alertas configuradas", "warning");
          return;
        }

        const rows = mapAlertsToSelectedFields(allAlerts, selectedFields);
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(workbook, worksheet, "Todas las Alertas");
        XLSX.writeFile(workbook, "all_alerts_custom.xlsx");

        setStatus(statusAll, `‚úÖ Exportadas ${allAlerts.length} alertas a all_alerts_custom.xlsx`, "success");
      } catch (err) {
        console.error(err);
        setStatus(statusAll, "‚ùå Error al exportar todas las alertas", "error");
      } finally {
        hideLoading();
      }
    });

    // üîπ Exportar todas las entidades con CONFIGURACI√ìN
    document.getElementById("exportEntitiesBtn").addEventListener("click", async () => {
      const statusEntities = document.getElementById("statusEntities");

      // 1. Obtener selecciones del usuario
      const selectedTypes = Array.from(document.querySelectorAll("#entityTypeSelectors input:checked")).map(i => i.value);
      const selectedFields = Array.from(document.querySelectorAll("#fieldSelectors input:checked")).map(i => i.value);

      if (selectedTypes.length === 0) {
        setStatus(statusEntities, "‚ö†Ô∏è Debes seleccionar al menos un tipo de entidad", "warning");
        return;
      }
      if (selectedFields.length === 0) {
        setStatus(statusEntities, "‚ö†Ô∏è Debes seleccionar al menos un campo para el Excel", "warning");
        return;
      }

      showLoading();
      try {
        // Fetch de todas las entidades (el filtro se hace en cliente)
        const allEntities = await fetchAlerts("entities");

        if (allEntities.length === 0) {
          setStatus(statusEntities, "‚ö†Ô∏è No hay entidades encontradas", "warning");
          return;
        }

        // 2. Filtrar por tipo seleccionado
        // Nota: Mapeamos algunos tipos que vienen del backend
        const filteredEntities = allEntities.filter(e => {
          // Si el tipo es mas detallado (como 'APM Service'), lo comparamos directo
          // Si es gen√©rico (como 'FIREWALL'), lo comparamos con lo que el usuario eligi√≥
          return selectedTypes.includes(e.type);
        });

        if (filteredEntities.length === 0) {
          setStatus(statusEntities, "‚ö†Ô∏è No hay entidades que coincidan con los tipos seleccionados", "warning");
          return;
        }

        // 3. Mapear solo los campos seleccionados
        const rows = filteredEntities.map(e => {
          const row = {};
          if (selectedFields.includes("Nombre")) row["Nombre"] = e.name;
          if (selectedFields.includes("Tipo")) row["Tipo"] = e.type;
          if (selectedFields.includes("TieneAlertas")) row["Tiene Alertas"] = e.hasAlerts ? "S√≠" : "No";
          if (selectedFields.includes("AlertasVinculadas")) row["Alertas Vinculadas"] = e.alertNames.join(", ");
          if (selectedFields.includes("GUID")) row["GUID"] = e.guid;
          return row;
        });

        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(workbook, worksheet, "Entidades_Filtradas");
        XLSX.writeFile(workbook, "entities_custom_report.xlsx");

        setStatus(statusEntities, `‚úÖ Exportadas ${filteredEntities.length} entidades a entities_custom_report.xlsx`, "success");
      } catch (err) {
        console.error(err);
        setStatus(statusEntities, "‚ùå Error al exportar entidades", "error");
      } finally {
        hideLoading();
      }
    });
  </script>

  <script src="assets/js/pantalla-carga.js"></script>
  <script src="assets/js/tab.js"></script>
  <script src="assets/js/particles.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

</body>

</html>