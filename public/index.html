<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Obserbavilidad</title>
  <link rel="icon" type="image/png" href="assets/logo-title.png">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* Estilos basados en la p√°gina de Node.js */
    :root {
      --color-primary: #2ea043;
      --color-secondary: #e6edf3;
      --color-dark-1: #191e25;
      --color-dark-2: #12161b;
      --color-dark-3: #0d1117;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: var(--color-dark-1);
      color: var(--color-secondary);
      position: relative;
      overflow: hidden;
      background-image: radial-gradient(rgba(46, 160, 67, 0.15) 2px, transparent 1px);
      background-size: 40px 40px;
    }


    .container {
      text-align: center;
      max-width: 600px;
      position: relative;
      z-index: 1;
      padding: 20px;
    }

    h1 {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      font-size: 2.5rem;
      font-weight: normal;
      margin-bottom: 20px;
      color: white;
      text-shadow: none;
    }

    .card {
      background-color: var(--color-dark-2);
      border: 1px solid #30363d;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      margin-top: 30px;
      padding: 20px 25px;
      text-align: left;
    }

    .card pre {
      margin: 0;
    }

    .card code {
      color: var(--color-secondary);
      font-family: monospace;
      font-size: 0.9em;
      text-shadow: 0 0 5px rgba(46, 160, 67, 0.5);
    }

    input,
    button {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      margin: 15px 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease-in-out;
    }

    input {
      width: 250px;
      background-color: #161b22;
      color: var(--color-secondary);
      border: 1px solid #30363d;
    }

    /* üîπ Flechas del input number al mismo color que el texto */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: inner-spin-button;
      filter: invert(90%) sepia(10%) saturate(200%) hue-rotate(180deg);
    }

    input[type=number] {
      -moz-appearance: textfield;
      /* Para Firefox */
    }

    button {
      background: linear-gradient(to right, #2e6438, #224b2b);
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: linear-gradient(to right, #4dbd6b, #2f7a45);
      /* Hover un poco m√°s claro */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }

    #status {
      margin-top: 20px;
      font-weight: bold;
      transition: color 0.3s;
    }

    /* --- Estilos para el nuevo men√∫ de pesta√±as --- */
    .tab-menu {
      display: flex;
      justify-content: flex-start;
      border-bottom: 1px solid #30363d;
    }

    .tab {
      padding: 10px 15px;
      cursor: pointer;
      color: #8b949e;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease-in-out;
    }

    .tab:hover {
      color: #e6edf3;
    }

    .tab.active {
      color: #e6edf3;
      border-bottom: 2px solid #2ea043;
    }

    .tab-content {
      display: none;
      padding-top: 20px;
    }

    .tab-content.active {
      display: block;
    }


  /* Overlay que bloquea la pantalla */
  #loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(13, 17, 23, 0.9); /* Fondo oscuro */
    display: none; /* Oculto por defecto */
    justify-content: center;
    align-items: center;
    flex-direction: column; /* Spinner arriba, texto abajo */
    z-index: 9999;
  }

  /* Spinner m√°s peque√±o */
  .spinner {
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top: 4px solid #2ea043;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 0.9s linear infinite;
    margin-bottom: 15px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Texto debajo del spinner */
  #loadingText {
    color: #fff;
    font-size: 16px;
    font-weight: 500;
    font-family: Arial, sans-serif;
    display: flex;
    align-items: center;
  }

  /* Puntitos animados suaves */
  .dot {
    animation: blink 1.5s infinite;
    opacity: 0;
  }

  .dot:nth-child(1) { animation-delay: 0s; }
  .dot:nth-child(2) { animation-delay: 0.3s; }
  .dot:nth-child(3) { animation-delay: 0.6s; }

  @keyframes blink {
    0%, 20% { opacity: 0; }
    30%, 80% { opacity: 1; }
    100% { opacity: 0; }
  }
  </style>
</head>

<body>
  <div class="container">
    <h1>Herramienta de Alertas New Relic</h1>

    <div class="card">
      <div class="tab-menu">
        <span class="tab active" onclick="showTab('tab-use')">Policy</span>
        <span class="tab" onclick="showTab('tab-example')">Alertas Configuradas</span>
      </div>

      <div id="tab-use" class="tab-content active">

        <p style="color:#79c0ff; font-size:1rem; margin-bottom:15px;">
          Ingresa un <strong>Policy ID</strong> para obtener informaci√≥n detallada de las alertas asociadas a esa
          pol√≠tica. Podr√°s exportarlas directamente a un archivo Excel.
        </p>
        <pre><code>
  // <span style="color:#2ea043; font-weight:bold;">C√≥mo usar la aplicaci√≥n:</span>

  <span style="color:#58a6ff;">1.</span> Escribe el <span style="color:#d2a8ff;">Policy ID</span> en el campo de texto. ¬†
  ¬† ¬†(Ejemplo: <span style="color:#ffa657;">1234567</span>)

  <span style="color:#58a6ff;">2.</span> Haz clic en 
  ¬† ¬†"<span style="color:#2ea043; font-weight:bold;">Exportar alertas</span>".

  <span style="color:#58a6ff;">3.</span> La app consultar√° la 
  ¬† ¬†<span style="color:#79c0ff;">API de New Relic</span> y, si existen alertas, ¬†
  ¬† ¬†descargar√° un archivo "<span style="color:#ff7b72;">alerts.xlsx</span>".

  <span style="color:#58a6ff;">4.</span> El archivo Excel contendr√°: ¬†
  ¬† ¬†- <span style="color:#d2a8ff;">ID</span>, <span style="color:#d2a8ff;">Nombre</span> y <span style="color:#d2a8ff;">Descripci√≥n</span> ¬†
  ¬† ¬†- Estado (<span style="color:#2ea043;">habilitada</span> o no) ¬†
  ¬† ¬†- Tipo de condici√≥n ¬†
  ¬† ¬†- Runbook asociado ¬†
  ¬† ¬†- Consulta <span style="color:#d2a8ff;">NRQL</span> ¬†
  ¬† ¬†- Detalles de umbral, operador, prioridad, ¬†
  ¬† ¬† ¬†duraci√≥n y ocurrencias

  <span style="color:#58a6ff;">5.</span> Si la <span style="color:#d2a8ff;">Policy ID</span> no tiene alertas asociadas, ¬†
  ¬† ¬†se mostrar√° un <span style="color:#ff7b72;">aviso en pantalla</span> ¬†
  ¬† ¬†y no se descargar√° ning√∫n archivo.
  ¬† </code></pre>

        <input type="number" id="policyId" placeholder="Ingrese Policy ID">
        <button id="exportBtn">Exportar alertas</button>
        <div id="status"></div>
      </div>


      <div id="tab-example" class="tab-content">
        <pre><code>
  // <span style="color:#2ea043; font-weight:bold;">Resumen de alertas configuradas:</span>

  Este panel permite exportar todas las alertas existentes en el sistema
  a un archivo Excel haciendo clic en 
  "<span style="color:#2ea043; font-weight:bold;">Exportar todas las alertas</span>".

  El archivo contendr√° para cada alerta:
    - <span style="color:#d2a8ff;">ID</span>, <span style="color:#d2a8ff;">Nombre</span> y <span style="color:#d2a8ff;">Descripci√≥n</span>
    - Estado (<span style="color:#2ea043;">habilitada</span> o no)
    - Tipo de condici√≥n
    - Runbook asociado
    - Consulta <span style="color:#d2a8ff;">NRQL</span>
    - Detalles de umbral, operador, prioridad, duraci√≥n y ocurrencias

  Si no hay alertas configuradas, se mostrar√° un aviso en pantalla.
  </code></pre>

        <button id="exportAllBtn">Exportar todas las alertas</button>
        <div id="statusAll"></div>
      </div>




    </div>


    <!-- Los inputs y el bot√≥n ahora est√°n dentro de la pesta√±a Policy -->
  </div>



  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>

    // const BASE_URL = window.location.hostname.includes("localhost") ?
    //   "http://localhost:3000" :
    //   "https://new-relic.onrender.com";

    const BASE_URL =
      "http://localhost:3000"

    // --- Contar alertas configuradas ---
    const countAlertsBtn = document.getElementById("countAlertsBtn");
    const alertsCountPanel = document.getElementById("alertsCountPanel");

    if (countAlertsBtn) {
      countAlertsBtn.addEventListener("click", async () => {
        alertsCountPanel.textContent = "‚è≥ Contando alertas...";
        try {
          const response = await fetch(`${BASE_URL}/alerts-all`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json"
            }
          });
          if (!response.ok) throw new Error("Error al obtener todas las alertas");
          const allAlerts = await response.json();
          alertsCountPanel.innerHTML = `<pre><code>// <span style="color:#ffdd57; font-weight:bold;">Total de alertas configuradas:</span> ${allAlerts.length}</code></pre>`;

        } catch (err) {
          console.error(err);
          alertsCountPanel.textContent = "‚ùå Error al contar las alertas.";
        }
      });
    }


    async function fetchAllAlerts(policyId) {
      const response = await fetch(`${BASE_URL}/alerts`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          policyId
        })
      });

      if (!response.ok) throw new Error("Error al obtener alertas del servidor");
      return await response.json();
    }

    function exportToExcel(conditions) {
      const rows = conditions.map(c => ({
        ID: c.id,
        Nombre: c.name,
        Descripci√≥n: c.description || "",
        Habilitada: c.enabled ? "S√≠" : "No",
        Tipo: c.type,
        Runbook: c.runbookUrl || "No",
        NRQL: c.nrql?.query || "",
        Umbral: c.terms?.[0]?.threshold || "",
        Operador: c.terms?.[0]?.operator || "",
        Prioridad: c.terms?.[0]?.priority || "",
        Duraci√≥nSegs: c.terms?.[0]?.thresholdDuration || "",
        Ocurrencias: c.terms?.[0]?.thresholdOccurrences || "",
        GuidEntidad: c.realEntity?.guid || "",
        NombreEntidad: c.realEntity?.name || "",
        TipoEntidad: c.realEntity?.type || ""
      }));

      const workbook = XLSX.utils.book_new();
      const worksheet = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(workbook, worksheet, "Alertas");
      XLSX.writeFile(workbook, "alerts.xlsx");

      return rows.length;
    }
    document.getElementById("exportBtn").addEventListener("click", async () => {
      const status = document.getElementById("status");
      const policyId = document.getElementById("policyId").value.trim();

      if (!policyId) {
        status.textContent = "‚ùå Debes ingresar una Policy ID";
        return;
      }

      statusAll.textContent = "";
      showLoading();
      try {
        const alerts = await fetchAllAlerts(policyId);

        if (alerts.length === 0) {
          status.textContent = "‚ö†Ô∏è No existen alertas asociadas a esta Policy ID";
          return; // üëà evita que se descargue el Excel
        }

        const count = exportToExcel(alerts);
        status.textContent = `‚úÖ Exportadas ${count} alertas a alerts.xlsx`;
        hideLoading();
      } catch (err) {
        console.error(err);
        status.textContent = "‚ùå Error al exportar alertas. Revisa la consola.";
      }
    });

    // --- L√≥gica del men√∫ de pesta√±as ---
    function showTab(tabId) {
      // Oculta todo el contenido de las pesta√±as
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Quita la clase 'active' de todas las pesta√±as
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Muestra el contenido de la pesta√±a seleccionada y activa la pesta√±a
      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active');
    }
  </script>

  <script>
    const alertCountEl = document.getElementById("alertCount");

    function exportAllToExcel(conditions) {
      const rows = conditions.map(c => ({
        ID: c.id,
        Nombre: c.name,
        Descripci√≥n: c.description || "",
        Habilitada: c.enabled ? "S√≠" : "No",
        Tipo: c.type,
        Runbook: c.runbookUrl || "No",
        NRQL: c.nrql?.query || "",
        Umbral: c.terms?.[0]?.threshold || "",
        Operador: c.terms?.[0]?.operator || "",
        Prioridad: c.terms?.[0]?.priority || "",
        Duraci√≥nSegs: c.terms?.[0]?.thresholdDuration || "",
        Ocurrencias: c.terms?.[0]?.thresholdOccurrences || "",
        GuidEntidad: c.realEntity?.guid || "",
        NombreEntidad: c.realEntity?.name || "",
        TipoEntidad: c.realEntity?.type || ""
      }));

      const workbook = XLSX.utils.book_new();
      const worksheet = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(workbook, worksheet, "Alertas");
      XLSX.writeFile(workbook, "all_alerts.xlsx");

      return rows.length;
    }

    document.getElementById("exportAllBtn").addEventListener("click", async () => {
      const statusAll = document.getElementById("statusAll");
      statusAll.textContent = "‚è≥ Obteniendo todas las alertas...";

      statusAll.textContent = "";
      showLoading();

      try {
        const response = await fetch(`${BASE_URL}/alerts-all`, {
          method: "GET",
          headers: { "Content-Type": "application/json" }
        });

        if (!response.ok) throw new Error("Error al obtener todas las alertas");

        const allAlerts = await response.json();
        if (allAlerts.length === 0) {


          statusAll.textContent = "‚ö†Ô∏è No hay alertas configuradas";
          return;
        }

        const count = exportAllToExcel(allAlerts);

        statusAll.innerHTML = `<pre><code>// <span style="color:#ffdd57; font-weight:bold;">‚úÖ Exportadas ${count} alertas a all_alerts.xlsx</span></code></pre>`;
        hideLoading();
      } catch (err) {
        console.error(err);
        statusAll.textContent = "‚ùå Error al exportar todas las alertas";
      }
    });


  const messages = [
    "Extrayendo alertas",
    "Espere un momento, por favor",
    "Cargando informaci√≥n"
  ];
  let msgIndex = 0;
  let messageInterval;

function startMessageRotation() {
  const loadingText = document.getElementById("loadingText");
  if (!loadingText) return;
  messageInterval = setInterval(() => {
    msgIndex = (msgIndex + 1) % messages.length;
    loadingText.childNodes[0].nodeValue = messages[msgIndex];
  }, 5000); // Cambia cada 5 segundos
}

  function stopMessageRotation() {
    clearInterval(messageInterval);
  }

  function showLoading() {
    const overlay = document.getElementById("loadingOverlay");
    if (!overlay) return;
    overlay.style.display = "flex";
    startMessageRotation();
  }

  function hideLoading() {
    const overlay = document.getElementById("loadingOverlay");
    if (!overlay) return;
    overlay.style.display = "none";
    stopMessageRotation();
  }

  </script>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div id="loadingText">Extrayendo alertas<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></div>
</div>
</body>

</html>